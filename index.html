<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CrickScore</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .input {
      border: 1px solid #ccc;
      padding: 0.4rem;
      border-radius: 0.25rem;
    }
    .btn {
      padding: 0.4rem 0.8rem;
      background: #4f46e5;
      color: white;
      border-radius: 0.25rem;
      cursor: pointer;
    }
    .btn:hover {
      background: #4338ca;
    }
    .btn:disabled {
      background: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-white text-gray-800 font-sans p-4 max-w-xl mx-auto">
  <h1 class="text-3xl font-bold mb-4 text-center">üèè CrickScore</h1>

  <div class="space-y-4">
    <div>
      <label>Team A: <input id="teamA" class="input" /></label>
      <label class="ml-4">Team B: <input id="teamB" class="input" /></label>
    </div>

    <div>
      <label>Overs: <input id="totalOvers" class="input w-20" type="number" min="1" /></label>
      <button onclick="startMatch()" class="btn ml-4">Start Match</button>
      <button onclick="clearHistory()" class="btn ml-2 bg-red-500 hover:bg-red-600">Clear History</button>
    </div>

    <div id="matchPanel" class="hidden space-y-4">
      <div class="text-lg font-semibold">üèè Match: <span id="matchTeams"></span> <span id="inningLabel">(1st Innings)</span></div>
      <div class="text-md">
        Score: <span id="score">0/0</span><br />
        Overs: <span id="overs">0.0</span><br />
        Run Rate: <span id="runRate">0.00</span><br />
        Overs Left: <span id="oversLeft">0.0</span>
      </div>

      <div class="space-x-2">
        <button onclick="addRun(1)" class="btn">1</button>
        <button onclick="addRun(2)" class="btn">2</button>
        <button onclick="addRun(3)" class="btn">3</button>
        <button onclick="addRun(4)" class="btn">4</button>
        <button onclick="addRun(6)" class="btn">6</button>
        <button onclick="addWide()" class="btn bg-yellow-400">Wide</button>
        <button onclick="addLegBye()" class="btn bg-green-400">Leg Bye</button>
        <button onclick="addWicket()" class="btn bg-red-500 hover:bg-red-600">Wicket</button>
      </div>

      <div class="space-x-2 mt-4">
        <button onclick="undoLastBall()" class="btn bg-gray-400">Undo</button>
        <button onclick="endMatch()" class="btn bg-gray-600 hover:bg-gray-700">End Match</button>
      </div>
    </div>

    <div id="scoreboard" class="mt-6 hidden">
      <h2 class="text-xl font-semibold mb-2">Full Scoreboard</h2>

      <h3 class="text-lg font-semibold">Batsmen</h3>
      <table class="w-full text-sm mb-4 border">
        <thead>
          <tr class="bg-gray-100">
            <th class="border px-2">Name</th>
            <th class="border px-2">Runs</th>
            <th class="border px-2">Balls</th>
            <th class="border px-2">4s</th>
            <th class="border px-2">6s</th>
            <th class="border px-2">Status</th>
          </tr>
        </thead>
        <tbody id="batsmanTable"></tbody>
      </table>

      <h3 class="text-lg font-semibold">Bowlers</h3>
      <table class="w-full text-sm border">
        <thead>
          <tr class="bg-gray-100">
            <th class="border px-2">Name</th>
            <th class="border px-2">Overs</th>
            <th class="border px-2">Runs</th>
            <th class="border px-2">Wickets</th>
          </tr>
        </thead>
        <tbody id="bowlerTable"></tbody>
      </table>
    </div>

    <div id="summary" class="mt-6 hidden">
      <h3 class="font-bold text-lg mb-2">üèÅ Match Summary</h3>
      <p id="winner"></p>
    </div>

    <div id="history" class="mt-6">
      <h3 class="font-bold text-lg mb-2">üìú Past Matches</h3>
      <ul id="matchHistory" class="list-disc pl-5 space-y-1"></ul>
    </div>
  </div>

<script>
  let history = JSON.parse(localStorage.getItem('crickHistory') || '[]');
  let inning = 1;
  let firstInningsScore = 0;
  let totalOvers = 0;

  // Match state
  let score = 0;
  let wickets = 0;
  let balls = 0; // legal balls bowled in current innings
  let batsmen = [];
  let bowlers = [];
  let currentBatsmanIndex = 0;
  let currentBowlerIndex = 0;
  let extras = 0;

  // Ball history stack for undo
  let ballHistory = [];

  function startMatch() {
    const teamA = document.getElementById("teamA").value.trim();
    const teamB = document.getElementById("teamB").value.trim();
    totalOvers = parseInt(document.getElementById("totalOvers").value);

    if (!teamA || !teamB || isNaN(totalOvers) || totalOvers <= 0) {
      alert("Please enter valid team names and overs.");
      return;
    }

    inning = 1;
    firstInningsScore = 0;
    score = 0;
    wickets = 0;
    balls = 0;
    extras = 0;
    ballHistory = [];

    // Prompt for opening batsmen and opening bowler
    batsmen = [];
    bowlers = [];
    currentBatsmanIndex = 0;
    currentBowlerIndex = 0;

    let striker = prompt("Enter name of opening striker batsman:");
    if (!striker) striker = "Batsman 1";
    let nonStriker = prompt("Enter name of non-striker batsman:");
    if (!nonStriker) nonStriker = "Batsman 2";
    let bowlerName = prompt("Enter name of opening bowler:");
    if (!bowlerName) bowlerName = "Bowler 1";

    batsmen.push({name: striker, runs:0, balls:0, fours:0, sixes:0, out:false});
    batsmen.push({name: nonStriker, runs:0, balls:0, fours:0, sixes:0, out:false});
    bowlers.push({name: bowlerName, balls:0, runs:0, wickets:0});

    document.getElementById("matchPanel").classList.remove("hidden");
    document.getElementById("scoreboard").classList.remove("hidden");
    document.getElementById("summary").classList.add("hidden");

    document.getElementById("matchTeams").textContent = `${teamA} vs ${teamB}`;
    document.getElementById("inningLabel").textContent = `(1st Innings)`;
    updateDisplay();
    renderScoreboard();
    renderHistory();
  }

  function addRun(runs) {
    if (isInningsOver()) return alert("Innings is over. End match or start 2nd innings.");

    const striker = batsmen[currentBatsmanIndex];
    const bowler = bowlers[currentBowlerIndex];

    // Update scores
    score += runs;
    striker.runs += runs;
    striker.balls++;
    bowler.runs += runs;

    // Count boundaries
    if (runs === 4) striker.fours++;
    if (runs === 6) striker.sixes++;

    balls++;
    bowler.balls++;

    // Save ball event for undo
    ballHistory.push({
      type: 'run',
      runs: runs,
      strikerIndex: currentBatsmanIndex,
      bowlerIndex: currentBowlerIndex,
      wicketsBefore: wickets,
      ballsBefore: balls - 1,
      scoreBefore: score - runs,
      batsmenBefore: JSON.parse(JSON.stringify(batsmen)),
      bowlersBefore: JSON.parse(JSON.stringify(bowlers)),
    });

    // Swap strike on odd runs
    if (runs % 2 === 1) swapStrike();

    checkOverComplete();
    updateDisplay();
    renderScoreboard();
    checkInningsEnd();
  }

  function addWide() {
    if (isInningsOver()) return alert("Innings is over. End match or start 2nd innings.");

    score++;
    extras++;

    const bowler = bowlers[currentBowlerIndex];
    bowler.runs++;

    // Wide balls do NOT count as legal balls, so balls and bowler.balls stay same

    ballHistory.push({
      type: 'wide',
      runs: 1,
      strikerIndex: currentBatsmanIndex,
      bowlerIndex: currentBowlerIndex,
      wicketsBefore: wickets,
      ballsBefore: balls,
      scoreBefore: score - 1,
      batsmenBefore: JSON.parse(JSON.stringify(batsmen)),
      bowlersBefore: JSON.parse(JSON.stringify(bowlers)),
    });

    updateDisplay();
    renderScoreboard();
  }

  function addLegBye() {
    if (isInningsOver()) return alert("Innings is over. End match or start 2nd innings.");

    score++;
    extras++;

    const bowler = bowlers[currentBowlerIndex];
    bowler.runs++;

    balls++;
    bowler.balls++;

    ballHistory.push({
      type: 'legbye',
      runs: 1,
      strikerIndex: currentBatsmanIndex,
      bowlerIndex: currentBowlerIndex,
      wicketsBefore: wickets,
      ballsBefore: balls - 1,
      scoreBefore: score - 1,
      batsmenBefore: JSON.parse(JSON.stringify(batsmen)),
      bowlersBefore: JSON.parse(JSON.stringify(bowlers)),
    });

    swapStrike();

    checkOverComplete();
    updateDisplay();
    renderScoreboard();
    checkInningsEnd();
  }

  function addWicket() {
    if (isInningsOver()) return alert("Innings is over. End match or start 2nd innings.");

    wickets++;
    balls++;
    bowlers[currentBowlerIndex].wickets++;
    bowlers[currentBowlerIndex].balls++;

    const outBatsman = batsmen[currentBatsmanIndex];
    outBatsman.out = true;

    ballHistory.push({
      type: 'wicket',
      strikerIndex: currentBatsmanIndex,
      bowlerIndex: currentBowlerIndex,
      wicketsBefore: wickets - 1,
      ballsBefore: balls - 1,
      scoreBefore: score,
      batsmenBefore: JSON.parse(JSON.stringify(batsmen)),
      bowlersBefore: JSON.parse(JSON.stringify(bowlers)),
    });

    // New batsman
    if (wickets < 10) {
      let newBatsmanName = prompt("Enter name of new batsman:");
      if (!newBatsmanName) newBatsmanName = `Batsman ${wickets + 2}`;
      batsmen[currentBatsmanIndex] = {name: newBatsmanName, runs:0, balls:0, fours:0, sixes:0, out:false};
    } else {
      alert("All out!");
      updateDisplay();
      renderScoreboard();
      checkInningsEnd();
      return;
    }

    updateDisplay();
    renderScoreboard();
    checkInningsEnd();
  }

  // Swap striker and non-striker indexes 0 and 1
  function swapStrike() {
    currentBatsmanIndex = currentBatsmanIndex === 0 ? 1 : 0;
  }

  // Check if over complete (6 legal balls)
  function checkOverComplete() {
    if (balls > 0 && balls % 6 === 0) {
      swapStrike();
      // Prompt for new bowler
      let newBowlerName = prompt("Over completed. Enter new bowler name:");
      if (!newBowlerName) newBowlerName = `Bowler ${bowlers.length + 1}`;
      bowlers.push({name: newBowlerName, balls: 0, runs: 0, wickets: 0});
      currentBowlerIndex = bowlers.length - 1;
    }
  }

  // Undo last ball event
  function undoLastBall() {
    if (ballHistory.length === 0) {
      alert("No balls to undo!");
      return;
    }
    const lastBall = ballHistory.pop();

    // Restore previous state
    score = lastBall.scoreBefore;
    wickets = lastBall.wicketsBefore;
    balls = lastBall.ballsBefore;
    batsmen = JSON.parse(JSON.stringify(lastBall.batsmenBefore));
    bowlers = JSON.parse(JSON.stringify(lastBall.bowlersBefore));

    // Reset striker and bowler index if needed
    // Find striker: first not out batsman
    currentBatsmanIndex = batsmen.findIndex(b => !b.out);
    if (currentBatsmanIndex === -1) currentBatsmanIndex = 0;
    currentBowlerIndex = lastBall.bowlerIndex;

    updateDisplay();
    renderScoreboard();
  }

  function updateDisplay() {
    document.getElementById("score").textContent = `${score}/${wickets}`;
    document.getElementById("overs").textContent = `${Math.floor(balls/6)}.${balls%6}`;
    let runRate = balls > 0 ? (score / (balls/6)) : 0;
    document.getElementById("runRate").textContent = runRate.toFixed(2);
    let oversLeft = totalOvers - Math.floor(balls/6) - ((balls%6)/6);
    oversLeft = oversLeft < 0 ? 0 : oversLeft;
    document.getElementById("oversLeft").textContent = oversLeft.toFixed(1);
  }

  function renderScoreboard() {
    const batsmanTable = document.getElementById("batsmanTable");
    batsmanTable.innerHTML = "";
    batsmen.forEach((b, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-2">${b.name}${i === currentBatsmanIndex && !b.out ? " (striker)" : ""}</td>
        <td class="border px-2">${b.runs}</td>
        <td class="border px-2">${b.balls}</td>
        <td class="border px-2">${b.fours}</td>
        <td class="border px-2">${b.sixes}</td>
        <td class="border px-2">${b.out ? "Out" : "Not Out"}</td>
      `;
      batsmanTable.appendChild(tr);
    });

    const bowlerTable = document.getElementById("bowlerTable");
    bowlerTable.innerHTML = "";
    bowlers.forEach(b => {
      const oversBowled = Math.floor(b.balls/6) + "." + (b.balls%6);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-2">${b.name}${b === bowlers[currentBowlerIndex] ? " (current)" : ""}</td>
        <td class="border px-2">${oversBowled}</td>
        <td class="border px-2">${b.runs}</td>
        <td class="border px-2">${b.wickets}</td>
      `;
      bowlerTable.appendChild(tr);
    });
  }

  function isInningsOver() {
    return wickets >= 10 || balls >= totalOvers * 6;
  }

  function checkInningsEnd() {
    if (isInningsOver()) {
      alert(`Innings over! Total Score: ${score}/${wickets}`);
    }
  }

  function endMatch() {
    const teamA = document.getElementById("teamA").value.trim();
    const teamB = document.getElementById("teamB").value.trim();

    if (inning === 1) {
      if (!isInningsOver()) {
        if (!confirm("1st Innings is not complete. Are you sure you want to end it?")) return;
      }
      firstInningsScore = score;
      inning = 2;

      // Reset stats for second innings
      score = 0;
      wickets = 0;
      balls = 0;
      extras = 0;
      ballHistory = [];

      // Prompt for new opening batsmen and bowler for 2nd innings
      batsmen = [];
      bowlers = [];
      currentBatsmanIndex = 0;
      currentBowlerIndex = 0;

      let striker = prompt("Enter name of opening striker batsman for 2nd Innings:");
      if (!striker) striker = "Batsman 1";
      let nonStriker = prompt("Enter name of non-striker batsman for 2nd Innings:");
      if (!nonStriker) nonStriker = "Batsman 2";
      let bowlerName = prompt("Enter name of opening bowler for 2nd Innings:");
      if (!bowlerName) bowlerName = "Bowler 1";

      batsmen.push({name: striker, runs:0, balls:0, fours:0, sixes:0, out:false});
      batsmen.push({name: nonStriker, runs:0, balls:0, fours:0, sixes:0, out:false});
      bowlers.push({name: bowlerName, balls:0, runs:0, wickets:0});

      document.getElementById("inningLabel").textContent = `(2nd Innings)`;
      updateDisplay();
      renderScoreboard();
      document.getElementById("summary").classList.add("hidden");

    } else {
      if (!confirm("Are you sure you want to end the match?")) return;

      // Determine winner
      let winnerText = "";
      if (score > firstInningsScore) {
        winnerText = `${teamB} won by ${10 - wickets} wicket(s)!`;
      } else if (score < firstInningsScore) {
        let runsDiff = firstInningsScore - score;
        winnerText = `${teamA} won by ${runsDiff} run(s)!`;
      } else {
        winnerText = "Match tied!";
      }

      // Save match history
      const matchSummary = {
        teams: `${teamA} vs ${teamB}`,
        score1: `${firstInningsScore}/10 (max overs)`,
        score2: `${score}/${wickets}`,
        winner: winnerText,
        date: new Date().toLocaleString()
      };
      history.unshift(matchSummary);
      localStorage.setItem('crickHistory', JSON.stringify(history));

      document.getElementById("summary").classList.remove("hidden");
      document.getElementById("winner").textContent = winnerText;

      document.getElementById("matchPanel").classList.add("hidden");
      document.getElementById("scoreboard").classList.add("hidden");

      renderHistory();
    }
  }

  function renderHistory() {
    const historyList = document.getElementById("matchHistory");
    historyList.innerHTML = "";
    if (history.length === 0) {
      historyList.innerHTML = "<li>No matches played yet.</li>";
      return;
    }
    history.forEach((match, idx) => {
      const li = document.createElement("li");
      li.textContent = `[${match.date}] ${match.teams} - 1st Innings: ${match.score1}, 2nd Innings: ${match.score2} => Winner: ${match.winner}`;
      historyList.appendChild(li);
    });
  }

  function clearHistory() {
    if (confirm("Are you sure you want to clear match history?")) {
      history = [];
      localStorage.removeItem('crickHistory');
      renderHistory();
    }
  }

  // Initial render of history on page load
  renderHistory();

</script>
</body>
</html>
